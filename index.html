<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>Legado 书源仓库</title>
    <style>
        :root {
            --primary-color: #2c3e50;
            --border-color: #e0e0e0;
            --bg-color: #f8f9fa;
        }
        body {
            font-family: "Segoe UI", sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            line-height: 1.6;
        }

        /* 头部样式 */
        header {
            display: flex;
            align-items: center;
            padding: 20px 0;
            margin-bottom: 30px;
            border-bottom: 2px solid var(--border-color);
        }
        .logo {
            width: 60px;
            height: 60px;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            margin-right: 20px;
        }
        .header-text h1 {
            margin: 0;
            font-size: 1.8em;
            color: var(--primary-color);
        }
        .header-text p {
            margin: 5px 0 0;
            color: #666;
            font-size: 0.95em;
        }

        /* 区块样式 */
        .section-block {
            padding: 25px;
            margin: 30px 0;
            background: var(--bg-color);
            border-radius: 10px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        }

        /* 列表样式 */
        .source-item {
            display: flex;
            align-items: center;
            padding: 15px;
            margin: 10px 0;
            background: white;
            border-radius: 8px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
        }
        .json-link {
            color: var(--primary-color);
            text-decoration: none;
            flex: 2;
            min-width: 180px;
        }
        .site-link {
            color: #666;
            text-decoration: none;
            flex: 3;
            font-size: 0.9em;
        }
        .copy-group {
            flex: 1;
            text-align: right;
            min-width: 160px;
        }

        /* 功能样式 */
        .search-box {
            width: 100%;
            padding: 12px;
            margin: 20px 0;
            border: 1px solid var(--border-color);
            border-radius: 25px;
            font-size: 1em;
        }
        #toast {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0,0,0,0.85);
            color: white;
            padding: 12px 25px;
            border-radius: 25px;
            font-size: 0.9em;
            display: none;
            backdrop-filter: blur(5px);
        }

        /* 移动端适配 */
        @media (max-width: 480px) {
            header { flex-direction: column; align-items: flex-start; }
            .logo { margin-bottom: 15px; }
            .source-item { flex-wrap: wrap; gap: 10px; }
            .copy-group { text-align: left; width: 100%; }
        }
    </style>
</head>
<body>
    <div id="toast"></div>

    <header>
        <img src="https://fammcao.github.io/legadoPublic/src/imgs/logo.jpg" class="logo" alt="网站Logo">
        <div class="header-text">
            <h1>Legado 自用书源仓库</h1>
            <p>Legado 3.X 阅读器专用书源集合，持续更新维护</p>
        </div>
    </header>

    <div class="section-block">
        <h2>📚 使用方法</h2>
        <ul>
            <li>将书源合集链接添加为规则订阅（自动更新）</li>
            <li>或复制单个书源链接到阅读APP手动添加</li>
        </ul>
    </div>

    <div class="section-block">
        <h2>📦 书源合集</h2>
        <div class="source-item">
            <a href="https://fammcao.github.io/legadoPublic/BookSources/bookSource.json"
               class="json-link"
               target="_blank">
               https://fammcao.github.io/legadoPublic/BookSources/bookSource.json
            </a>
            <div class="copy-group">
                <button onclick="copyUrl('https://fammcao.github.io/legadoPublic/BookSources/bookSource.json','合集')" 
                        class="copy-btn">复制合集</button>
            </div>
        </div>
    </div>

    <div class="section-block">
        <h2>🔍 单个书源列表</h2>
        <input type="text" id="searchInput" class="search-box" placeholder="输入书源名称/网址搜索...">
        <div id="sourceList" class="loading">正在加载书源列表...</div>
    </div>

    <script>
        const BASE_URL = 'https://fammcao.github.io/legadoPublic/BookSources/';
        let cachedFiles = null;

        // 增强版获取所有JSON文件（带缓存和去重）
        async function getAllFiles() {
            if(cachedFiles) return cachedFiles;
            
            const seen = new Set();
            let allFiles = [];
            let page = 1;

            try {
                while(true) {
                    const response = await fetch(
                        `https://api.github.com/repos/FamMcao/legadoPublic/contents/BookSources/each?page=${page}`,
                        { headers: { 'Accept': 'application/vnd.github.v3+json' } }
                    );
                    
                    if(!response.ok) break;
                    
                    const files = await response.json();
                    if(files.length === 0) break;

                    // 严格过滤和去重
                    files.forEach(file => {
                        const fileName = file.name.toLowerCase();
                        if(fileName.endsWith('.json') && !seen.has(fileName)) {
                            seen.add(fileName);
                            allFiles.push(file);
                        }
                    });
                    
                    page++;
                }
            } catch(e) {
                console.error('获取文件列表失败:', e);
            }
            
            cachedFiles = allFiles;
            return allFiles;
        }

        // 增强数据加载逻辑
        async function loadSources() {
            try {
                const files = await getAllFiles();
                let html = '';
                const loadedUrls = new Set();

                for(const file of files) {
                    try {
                        const jsonUrl = `${BASE_URL}each/${encodeURIComponent(file.name)}`;
                        
                        // 防止重复加载
                        if(loadedUrls.has(jsonUrl)) continue;
                        loadedUrls.add(jsonUrl);

                        const res = await fetch(jsonUrl);
                        if(!res.ok) {
                            console.warn('文件加载失败:', jsonUrl, res.status);
                            continue;
                        }
                        
                        const data = await res.json().catch(e => {
                            console.warn('JSON解析失败:', jsonUrl, e);
                            return null;
                        });
                        
                        if(!data || !data.bookSourceName) continue;

                        const chineseName = data.bookSourceName.match(/【(.*?)】/)?.[1] || file.name;
                        const siteUrl = data.bookSourceUrl?.startsWith('http') 
                            ? data.bookSourceUrl 
                            : `http://${data.bookSourceUrl}`;

                        html += `
                            <div class="source-item">
                                <a href="${jsonUrl}" class="json-link" target="_blank">${chineseName}</a>
                                <a href="${siteUrl}" class="site-link" target="_blank">${data.bookSourceUrl}</a>
                                <div class="copy-group">
                                    <button onclick="copyUrl('${jsonUrl}', '书源')">复制书源</button>
                                    <button onclick="copyUrl('${siteUrl}', '网址')">复制网址</button>
                                </div>
                            </div>
                        `;
                    } catch(e) {
                        console.warn('处理文件失败:', file.name, e);
                    }
                }
                
                document.getElementById('sourceList').innerHTML = html || 
                    '<div style="color:#666; text-align:center">暂无可用书源</div>';
            } catch(error) {
                document.getElementById('sourceList').innerHTML = 
                    '<div style="color:red">加载失败，请<a href="javascript:location.reload()">刷新重试</a></div>';
            }
        }

        // 复制功能
        function copyUrl(text, type) {
            navigator.clipboard.writeText(text)
                .then(() => showToast(`✅ ${type}已复制`))
                .catch(() => {
                    const textarea = document.createElement('textarea');
                    textarea.value = text;
                    document.body.appendChild(textarea);
                    textarea.select();
                    document.execCommand('copy');
                    document.body.removeChild(textarea);
                    showToast('📋 复制成功');
                });
        }

        // 显示提示
        function showToast(msg) {
            const toast = document.getElementById('toast');
            toast.textContent = msg;
            toast.style.display = 'block';
            setTimeout(() => toast.style.display = 'none', 1500);
        }

        // 搜索功能（带输入防抖）
        let searchTimer;
        document.getElementById('searchInput').addEventListener('input', (e) => {
            clearTimeout(searchTimer);
            searchTimer = setTimeout(() => {
                const query = e.target.value.trim().toLowerCase();
                document.querySelectorAll('.source-item').forEach(item => {
                    const text = item.textContent.toLowerCase();
                    item.style.display = text.includes(query) ? 'flex' : 'none';
                });
            }, 300);
        });

        // 初始化加载
        window.addEventListener('DOMContentLoaded', loadSources);
    </script>
</body>
</html>
