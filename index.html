<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>Legado ä¹¦æºä»“åº“</title>
    <style>
        :root {
            --primary-color: #2c3e50;
            --border-color: #e0e0e0;
            --bg-color: #f8f9fa;
        }
        body {
            font-family: "Segoe UI", sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            line-height: 1.6;
        }

        /* å¤´éƒ¨æ ·å¼ */
        header {
            display: flex;
            align-items: center;
            padding: 20px 0;
            margin-bottom: 30px;
            border-bottom: 2px solid var(--border-color);
        }
        .logo {
            width: 60px;
            height: 60px;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            margin-right: 20px;
        }
        .header-text h1 {
            margin: 0;
            font-size: 1.8em;
            color: var(--primary-color);
        }
        .header-text p {
            margin: 5px 0 0;
            color: #666;
            font-size: 0.95em;
        }

        /* åŒºå—æ ·å¼ */
        .section-block {
            padding: 25px;
            margin: 30px 0;
            background: var(--bg-color);
            border-radius: 10px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        }

        /* åˆ—è¡¨æ ·å¼ */
        .source-item {
            display: flex;
            align-items: center;
            padding: 15px;
            margin: 10px 0;
            background: white;
            border-radius: 8px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
        }
        .json-link {
            color: var(--primary-color);
            text-decoration: none;
            flex: 2;
            min-width: 180px;
        }
        .site-link {
            color: #666;
            text-decoration: none;
            flex: 3;
            font-size: 0.9em;
        }
        .copy-group {
            flex: 1;
            text-align: right;
            min-width: 160px;
        }

        /* åŠŸèƒ½æ ·å¼ */
        .search-box {
            width: 100%;
            padding: 12px;
            margin: 20px 0;
            border: 1px solid var(--border-color);
            border-radius: 25px;
            font-size: 1em;
        }
        #toast {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0,0,0,0.85);
            color: white;
            padding: 12px 25px;
            border-radius: 25px;
            font-size: 0.9em;
            display: none;
            backdrop-filter: blur(5px);
        }

        /* ç§»åŠ¨ç«¯é€‚é… */
        @media (max-width: 480px) {
            header { flex-direction: column; align-items: flex-start; }
            .logo { margin-bottom: 15px; }
            .source-item { flex-wrap: wrap; gap: 10px; }
            .copy-group { text-align: left; width: 100%; }
        }
    </style>
</head>
<body>
    <div id="toast"></div>

    <header>
        <img src="https://fammcao.github.io/legadoPublic/src/imgs/logo.jpg" class="logo" alt="ç½‘ç«™Logo">
        <div class="header-text">
            <h1>Legado è‡ªç”¨ä¹¦æºä»“åº“</h1>
            <p>Legado 3.X é˜…è¯»å™¨ä¸“ç”¨ä¹¦æºé›†åˆï¼ŒæŒç»­æ›´æ–°ç»´æŠ¤</p>
        </div>
    </header>

    <div class="section-block">
        <h2>ğŸ“š ä½¿ç”¨æ–¹æ³•</h2>
        <ul>
            <li>å°†ä¹¦æºåˆé›†é“¾æ¥æ·»åŠ ä¸ºè§„åˆ™è®¢é˜…ï¼ˆè‡ªåŠ¨æ›´æ–°ï¼‰</li>
            <li>æˆ–å¤åˆ¶å•ä¸ªä¹¦æºé“¾æ¥åˆ°é˜…è¯»APPæ‰‹åŠ¨æ·»åŠ </li>
        </ul>
    </div>

    <div class="section-block">
        <h2>ğŸ“¦ ä¹¦æºåˆé›†</h2>
        <div class="source-item">
            <a href="https://fammcao.github.io/legadoPublic/BookSources/bookSource.json"
               class="json-link"
               target="_blank">
               https://fammcao.github.io/legadoPublic/BookSources/bookSource.json
            </a>
            <div class="copy-group">
                <button onclick="copyUrl('https://fammcao.github.io/legadoPublic/BookSources/bookSource.json','åˆé›†')" 
                        class="copy-btn">å¤åˆ¶åˆé›†</button>
            </div>
        </div>
    </div>

    <div class="section-block">
        <h2>ğŸ” å•ä¸ªä¹¦æºåˆ—è¡¨</h2>
        <input type="text" id="searchInput" class="search-box" placeholder="è¾“å…¥ä¹¦æºåç§°/ç½‘å€æœç´¢...">
        <div id="sourceList" class="loading">æ­£åœ¨åŠ è½½ä¹¦æºåˆ—è¡¨...</div>
    </div>

    <script>
        const BASE_URL = 'https://fammcao.github.io/legadoPublic/BookSources/';
        let cachedFiles = null;

        // å¢å¼ºç‰ˆè·å–æ‰€æœ‰JSONæ–‡ä»¶ï¼ˆå¸¦ç¼“å­˜å’Œå»é‡ï¼‰
        async function getAllFiles() {
            if(cachedFiles) return cachedFiles;
            
            const seen = new Set();
            let allFiles = [];
            let page = 1;

            try {
                while(true) {
                    const response = await fetch(
                        `https://api.github.com/repos/FamMcao/legadoPublic/contents/BookSources/each?page=${page}`,
                        { headers: { 'Accept': 'application/vnd.github.v3+json' } }
                    );
                    
                    if(!response.ok) break;
                    
                    const files = await response.json();
                    if(files.length === 0) break;

                    // ä¸¥æ ¼è¿‡æ»¤å’Œå»é‡
                    files.forEach(file => {
                        const fileName = file.name.toLowerCase();
                        if(fileName.endsWith('.json') && !seen.has(fileName)) {
                            seen.add(fileName);
                            allFiles.push(file);
                        }
                    });
                    
                    page++;
                }
            } catch(e) {
                console.error('è·å–æ–‡ä»¶åˆ—è¡¨å¤±è´¥:', e);
            }
            
            cachedFiles = allFiles;
            return allFiles;
        }

        // å¢å¼ºæ•°æ®åŠ è½½é€»è¾‘
        async function loadSources() {
            try {
                const files = await getAllFiles();
                let html = '';
                const loadedUrls = new Set();

                for(const file of files) {
                    try {
                        const jsonUrl = `${BASE_URL}each/${encodeURIComponent(file.name)}`;
                        
                        // é˜²æ­¢é‡å¤åŠ è½½
                        if(loadedUrls.has(jsonUrl)) continue;
                        loadedUrls.add(jsonUrl);

                        const res = await fetch(jsonUrl);
                        if(!res.ok) {
                            console.warn('æ–‡ä»¶åŠ è½½å¤±è´¥:', jsonUrl, res.status);
                            continue;
                        }
                        
                        const data = await res.json().catch(e => {
                            console.warn('JSONè§£æå¤±è´¥:', jsonUrl, e);
                            return null;
                        });
                        
                        if(!data || !data.bookSourceName) continue;

                        const chineseName = data.bookSourceName.match(/ã€(.*?)ã€‘/)?.[1] || file.name;
                        const siteUrl = data.bookSourceUrl?.startsWith('http') 
                            ? data.bookSourceUrl 
                            : `http://${data.bookSourceUrl}`;

                        html += `
                            <div class="source-item">
                                <a href="${jsonUrl}" class="json-link" target="_blank">${chineseName}</a>
                                <a href="${siteUrl}" class="site-link" target="_blank">${data.bookSourceUrl}</a>
                                <div class="copy-group">
                                    <button onclick="copyUrl('${jsonUrl}', 'ä¹¦æº')">å¤åˆ¶ä¹¦æº</button>
                                    <button onclick="copyUrl('${siteUrl}', 'ç½‘å€')">å¤åˆ¶ç½‘å€</button>
                                </div>
                            </div>
                        `;
                    } catch(e) {
                        console.warn('å¤„ç†æ–‡ä»¶å¤±è´¥:', file.name, e);
                    }
                }
                
                document.getElementById('sourceList').innerHTML = html || 
                    '<div style="color:#666; text-align:center">æš‚æ— å¯ç”¨ä¹¦æº</div>';
            } catch(error) {
                document.getElementById('sourceList').innerHTML = 
                    '<div style="color:red">åŠ è½½å¤±è´¥ï¼Œè¯·<a href="javascript:location.reload()">åˆ·æ–°é‡è¯•</a></div>';
            }
        }

        // å¤åˆ¶åŠŸèƒ½
        function copyUrl(text, type) {
            navigator.clipboard.writeText(text)
                .then(() => showToast(`âœ… ${type}å·²å¤åˆ¶`))
                .catch(() => {
                    const textarea = document.createElement('textarea');
                    textarea.value = text;
                    document.body.appendChild(textarea);
                    textarea.select();
                    document.execCommand('copy');
                    document.body.removeChild(textarea);
                    showToast('ğŸ“‹ å¤åˆ¶æˆåŠŸ');
                });
        }

        // æ˜¾ç¤ºæç¤º
        function showToast(msg) {
            const toast = document.getElementById('toast');
            toast.textContent = msg;
            toast.style.display = 'block';
            setTimeout(() => toast.style.display = 'none', 1500);
        }

        // æœç´¢åŠŸèƒ½ï¼ˆå¸¦è¾“å…¥é˜²æŠ–ï¼‰
        let searchTimer;
        document.getElementById('searchInput').addEventListener('input', (e) => {
            clearTimeout(searchTimer);
            searchTimer = setTimeout(() => {
                const query = e.target.value.trim().toLowerCase();
                document.querySelectorAll('.source-item').forEach(item => {
                    const text = item.textContent.toLowerCase();
                    item.style.display = text.includes(query) ? 'flex' : 'none';
                });
            }, 300);
        });

        // åˆå§‹åŒ–åŠ è½½
        window.addEventListener('DOMContentLoaded', loadSources);
    </script>
</body>
</html>
