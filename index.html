<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>Legado 书源仓库</title>
    <style>
        :root { --primary-color: #2c3e50; }
        body { 
            font-family: "Segoe UI", sans-serif; 
            max-width: 800px; 
            margin: 0 auto; 
            padding: 20px; 
        }
        
        /* 头部样式 */
        header { 
            display: flex; 
            align-items: center;
            margin-bottom: 30px;
            gap: 20px;
        }
        .logo { 
            width: 60px; 
            height: 60px;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        .header-text h1 {
            margin: 0;
            font-size: 1.8em;
            color: var(--primary-color);
        }
        .header-text p {
            margin: 0;
            color: #666;
            font-size: 0.95em;
        }

        /* 通用样式 */
        .copy-btn { 
            cursor: pointer; 
            color: #2980b9; 
            margin-left: 10px; 
            font-size: 0.9em; 
            background: none;
            border: none;
            padding: 2px 5px;
        }
        .search-box { 
            width: 100%; 
            padding: 10px; 
            margin: 20px 0; 
            border: 1px solid #ddd; 
            border-radius: 4px;
        }
        .source-item { 
            padding: 15px; 
            border-bottom: 1px solid #eee; 
            display: flex;
            align-items: center;
            flex-wrap: wrap;
            gap: 10px;
        }
        .source-item:hover { background: #f9f9f9; }
        .json-link { 
            color: var(--primary-color); 
            text-decoration: none;
            min-width: 150px;
        }
        .json-link:hover { text-decoration: underline; }
        .site-link {
            color: #666;
            text-decoration: none;
            font-size: 0.9em;
        }
        .site-link:hover { color: #2980b9; }

        /* 移动端适配 */
        @media (max-width: 480px) {
            header { flex-direction: column; align-items: flex-start; gap: 10px; }
            .logo { width: 50px; height: 50px; }
            .header-text h1 { font-size: 1.5em; }
        }
    </style>
</head>
<body>
    <header>
        <img src="/src/imgs/logo.jpg" class="logo" alt="网站logo">
        <div class="header-text">
            <h1>Legado 自用书源仓库</h1>
            <p>Legado 3.X 阅读器专用书源集合，持续更新维护</p>
        </div>
    </header>

    <section>
        <h2>📚 使用方法</h2>
        <ul>
            <li>方法一：将书源合集链接添加为规则订阅</li>
            <li>方法二：复制单个书源链接到阅读APP添加</li>
        </ul>
    </section>

    <section>
        <h2>📦 书源合集</h2>
        <div id="main-source">
            <a href="https://fammcao.github.io/legadoPublic/BookSources/BookSource.json" 
               class="json-link"
               target="_blank">
               https://fammcao.github.io/legadoPublic/BookSources/BookSource.json
            </a>
            <button onclick="copyUrl('https://fammcao.github.io/legadoPublic/BookSources/BookSource.json')" 
                    class="copy-btn">复制链接</button>
        </div>
    </section>

    <section>
        <h2>🔍 单个书源列表</h2>
        <input type="text" id="searchInput" class="search-box" placeholder="输入书源名称或网址搜索...">
        <div id="sourceList"></div>
    </section>

    <script>
        // 提取中文名函数
        function extractChineseName(text) {
            const match = text.match(/【(.*?)】/);
            return match ? match[1] : text;
        }

        // 自动加载书源列表
        window.onload = async () => {
            try {
                const response = await fetch('https://api.github.com/repos/FamMcao/legadoPublic/contents/BookSources/each');
                const files = await response.json();
                
                let html = '';
                for (const file of files) {
                    if (file.name.endsWith('.json')) {
                        const jsonUrl = `https://fammcao.github.io/legadoPublic/BookSources/each/${file.name}`;
                        const res = await fetch(jsonUrl);
                        const data = await res.json();
                        
                        // 处理数据
                        const chineseName = extractChineseName(data.bookSourceName);
                        const siteUrl = data.bookSourceUrl.startsWith('http') 
                            ? data.bookSourceUrl 
                            : `http://${data.bookSourceUrl}`;

                        html += `
                            <div class="source-item">
                                <a href="${jsonUrl}" class="json-link" target="_blank">${chineseName}</a>
                                <a href="${siteUrl}" class="site-link" target="_blank">${data.bookSourceUrl}</a>
                                <div style="margin-left: auto;">
                                    <button onclick="copyUrl('${jsonUrl}')" class="copy-btn">复制书源</button>
                                    <button onclick="copyUrl('${siteUrl}')" class="copy-btn">复制网址</button>
                                </div>
                            </div>
                        `;
                    }
                }
                document.getElementById('sourceList').innerHTML = html;
            } catch (error) {
                console.error('加载书源失败:', error);
                document.getElementById('sourceList').innerHTML = '<div style="color:red">书源加载失败，请刷新重试</div>';
            }
        };

        // 搜索功能（带防抖）
        let searchTimer;
        document.getElementById('searchInput').addEventListener('input', (e) => {
            clearTimeout(searchTimer);
            searchTimer = setTimeout(() => {
                const query = e.target.value.toLowerCase();
                document.querySelectorAll('.source-item').forEach(item => {
                    const text = item.textContent.toLowerCase();
                    item.style.display = text.includes(query) ? 'flex' : 'none';
                });
            }, 300);
        });

        // 改进版复制函数
        function copyUrl(text) {
            navigator.clipboard.writeText(text)
                .then(() => alert('已复制到剪贴板'))
                .catch(() => {
                    const textarea = document.createElement('textarea');
                    textarea.value = text;
                    document.body.appendChild(textarea);
                    textarea.select();
                    document.execCommand('copy');
                    document.body.removeChild(textarea);
                    alert('已手动复制到剪贴板');
                });
        }
    </script>
</body>
</html>
